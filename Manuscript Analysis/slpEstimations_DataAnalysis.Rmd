---
title: "SLP Estimations: Data Analysis"
output: html_notebook
---

This is the analysis script for the manuscript entitled "The reliability and validity of SLPs' esitmations of speech intelligibility in dysarthria". Much of the analysis and code is the same from the 2021 ASHA Convention poster presentation. However, some of the data visualizations and tables have changed.

# Packages

```{r}

library(rio) # install.packages("rio")
library(tidyverse) # install.packages("tidyverse")
library(performance) # install.packages("performance")
library(see) # install.packages("see")
library(patchwork) # install.packages("patchwork")
library(rmcorr) #install.packages("rmcorr")
library(irr) #install.packages("irr")
library(Hmisc) #install.packages("Hmisc")
library(ggpubr) #install.packages("ggpubr")
library(extrafont) # install.packages("extrafont")
library(gt) #install.packages("gt")
library(sjPlot) #install.packages("sjPlot")

```

# Importing the datasets

This chunk contains all of the dataframes needed for the stat analysis.

```{r}
# This data is used for question #1
IntSpeakerRatings <- rio::import("Shared Data/SpeakerIntelligibility.csv")

# This data is used for question #2 & #4
slp_Demographics <- rio::import("Shared Data/SLP_Demographics.csv")
slp_Correlation <- rio::import("Shared Data/SLP_Correlation.csv")

# This data is used for question #3
naive_Demographics <- rio::import("Shared Data/NaiveListener_Demographics.csv")
naive_Correlation <- rio::import("Shared Data/NaiveListener_Correlation.csv")

```

# Descriptive Stats

## SLP Demographics

```{r}

slp_gender <- slp_Demographics %>%
  dplyr::select(gender) %>%
  dplyr::group_by(gender) %>%
  dplyr::summarize(Frequency = n()) %>%
  dplyr::rename(Category = "gender") %>%
  dplyr::mutate(Group = "Gender",
                Category = fct_relevel(Category, c("Woman", "Man", "Prefer not to say"))) %>%
  dplyr::arrange(Category)

slp_race <- slp_Demographics %>%
  dplyr::select(race) %>%
  dplyr::group_by(race) %>%
  dplyr::summarize(Frequency = n()) %>%
  dplyr::rename(Category = "race") %>%
  dplyr::mutate(Group = "Race")

slp_ethnicity <- slp_Demographics %>%
  dplyr::select(ethnicity) %>%
  dplyr::group_by(ethnicity) %>%
  dplyr::summarize(Frequency = n()) %>%
  dplyr::rename(Category = "ethnicity") %>%
  dplyr::mutate(Group = "Ethnicity")

slp_demo1 <- dplyr::full_join(slp_gender, slp_race)

slp_demo1 <- dplyr::full_join(slp_demo1, slp_ethnicity)
  
slp_demo_table <- slp_demo1 %>%
  gt::gt(rowname_col = "Category", groupname_col = "Group")

slp_demo2 <- slp_Demographics %>%
  dplyr::select(c(age, yearsExp)) %>%
  tidyr::pivot_longer(cols = c(age, yearsExp), names_to = "Variable", values_to = "Value") %>%
  dplyr::mutate(Variable = recode(Variable, age = "Age", yearsExp = "Years Experience")) %>%
  dplyr::group_by(Variable) %>%
  dplyr::summarize(Mean = mean(Value), SD = sd(Value), Min = min(Value), Max = max(Value)) %>%
  gt::gt() %>%
  gt::fmt_number(columns = c(Mean, SD), decimals = 2)

rm(slp_gender, slp_race, slp_ethnicity, slp_demo1)

```

## Naive Listener Demographics

```{r}

naive_Demographics %>%
  furniture::table1(age, gender, race, ethnicity, famSLHDs)

naive_gender <- naive_Demographics %>%
  dplyr::select(gender) %>%
  dplyr::group_by(gender) %>%
  dplyr::summarize(Frequency = n()) %>%
  dplyr::rename(Category = "gender") %>%
  dplyr::mutate(Group = "Gender",
                Category = fct_relevel(Category, c("Woman", "Man", "Prefer not to say"))) %>%
  dplyr::arrange(Category)

naive_race <- naive_Demographics %>%
  dplyr::select(race) %>%
  dplyr::group_by(race) %>%
  dplyr::summarize(Frequency = n()) %>%
  dplyr::rename(Category = "race") %>%
  dplyr::mutate(Group = "Race")

naive_ethnicity <- naive_Demographics %>%
  dplyr::select(ethnicity) %>%
  dplyr::group_by(ethnicity) %>%
  dplyr::summarize(Frequency = n()) %>%
  dplyr::rename(Category = "ethnicity") %>%
  dplyr::mutate(Group = "Ethnicity")

naive_famSLHDs <- naive_Demographics %>%
  dplyr::select(famSLHDs) %>%
  dplyr::group_by(famSLHDs) %>%
  dplyr::summarize(Frequency = n()) %>%
  dplyr::rename(Category = "famSLHDs") %>%
  dplyr::mutate(Group = "Familiar with Comm Disorders")

naive_demo1 <- dplyr::full_join(naive_gender, naive_race)

naive_demo2 <- dplyr::full_join(naive_demo1, naive_ethnicity)

naive_demo3 <- dplyr::full_join(naive_demo2, naive_famSLHDs)

naive_demo_table <- naive_demo3 %>%
  gt::gt(rowname_col = "Category", groupname_col = "Group")

naive_age <- naive_Demographics %>%
  dplyr::summarize(Age_mean = mean(age), Age_sd = sd(age), Age_min = min(age), Age_max = max(age))

rm(naive_gender, naive_race, naive_ethnicity, naive_famSLHDs, slp_demo1, naive_demo2, naive_demo3)

```

## SLP and Naive Listener Descriptive Measures by Speaker (including SD here)

```{r}

# Print mean and SD

SLP_data <- slp_Correlation %>%
  dplyr::select(!c(slp_VAS.Rel, slp_EST.Rel)) %>%
  tidyr::pivot_longer(cols = slp_VAS:slp_EST, names_to = "Method", values_to = "Int") %>%
  dplyr::mutate(Method = ifelse(Method == "slp_EST", "SLP Estimation", "SLP VAS Rating")) %>%
  dplyr::group_by(Speaker, Method) %>%
  dplyr::summarize(Mean = mean(Int, na.rm = T), SD = sd(Int, na.rm = T),
                   Min = min(Int, na.rm =T ), Max = max(Int, na.rm = T))

naive_data <- naive_Correlation %>%
  dplyr::select(!naive_VAS) %>%
  dplyr::group_by(SpeakerID) %>%
  dplyr::summarize(Mean = mean(naive_OT), SD = sd(naive_OT), Min = min(naive_OT), Max = max(naive_OT)) %>%
  dplyr::mutate(Method = "Naïve OT") %>%
  dplyr::rename(Speaker = "SpeakerID")

Descriptives_table <- full_join(SLP_data, naive_data)



```


## Descriptives Plot

```{r}


intRatings_Long1 <- slp_Correlation %>%
  dplyr::rename(SpeakerID = Speaker) %>%
  dplyr::select(c(SpeakerID, slp_VAS, slp_EST)) %>%
  pivot_longer(cols = slp_EST:slp_VAS,
               names_to = "RatingType",
               values_to = "Ratings")

intRatings_Long2 <- naive_Correlation %>%
  dplyr::select(c(SpeakerID, naive_OT)) %>%
  pivot_longer(cols = naive_OT,
               names_to = "RatingType",
               values_to = "Ratings")

plot_data <- base::rbind(intRatings_Long1, intRatings_Long2) %>%
  dplyr::mutate(RatingType = as.factor(RatingType)) %>%
  dplyr::mutate(RatingType = recode_factor(RatingType,
                                           "naive_OT" = "Naive (Transcriptions)",
                                           "slp_VAS" = "SLP (VAS)",
                                           "slp_EST" = "SLP (Estimations)")) %>%
  dplyr::mutate(RatingType = fct_relevel(RatingType,
                                                "Naive (Transcriptions)",
                                                "slp_VAS" = "SLP (VAS)",
                                                "slp_EST" = "SLP (Estimations)"))

# custom colors
my_pal <- c("#086375", "#B147C2", "#3C1642", "#0FB1D2")

# Difference Plots: Word Trans ----                                                       
plot_data %>%
  ggplot() +
       aes(x = RatingType,
           y = Ratings,
           color = RatingType,
           fill = RatingType) + 
  ggdist::stat_halfeye(
    adjust = 1.3, 
    width = .6, 
    .width = 0, 
    justification = -.2,
    point_colour = NA,
    outline_bars = T
  ) + 
  scale_alpha_discrete(range = c(.4,.9), guide = "none") +
  geom_boxplot(
    width = .15, 
    outlier.shape = NA,
    fill = "white"
  ) +
  ## add justified jitter from the {gghalves} package
  gghalves::geom_half_point(
    ## draw jitter on the left
    side = "l", 
    ## control range of jitter
    range_scale = .4, 
    ## add some transparency
    alpha = .3
  ) +
  coord_cartesian(xlim = c(0, 100), clip = "off") +
  coord_flip() +
  scale_color_manual(values = my_pal, guide = "none") +
  scale_fill_manual(values = my_pal, guide = "none") +
  ylab("Intelligibility") +
  xlab("") +
  theme_classic() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(text=element_text(size = 13, 
        family="Arial Bold"))

ggsave("Plots/Distribution_plot.png", plot = last_plot(),height = 5, width = 7, units = "in", scale = .8)

```


# Research Question #1

Q1: Are SLP estimates of speech intelligibility predictive of naive listener estimations?

Since the speakers are the common variable between the SLP and Naive listener task, intelligibility scores for each method were calculated by speaker.

## Correlation Matrix

This first block explores the correlation matrix of SLP and Naive listener intelligibility ratings. 

```{r}

CorrMatrix <- IntSpeakerRatings %>%
  dplyr::select(!SpeakerID) %>%
  as.matrix() %>%
  Hmisc::rcorr() 

CorrMatrixP <- CorrMatrix$P < .05

CorrMatrix <- CorrMatrix$r

CorrMatrix <- CorrMatrix %>%
  as.data.frame() %>%
  dplyr::mutate(naive_VAS = as.numeric(naive_VAS),
                naive_OT = as.numeric(naive_OT),
                slp_EST = as.numeric(slp_EST),
                slp_VAS = as.numeric(slp_VAS)) %>%
  gt::gt() %>%
  gt::fmt_number(columns = c(naive_VAS, naive_OT, slp_EST, slp_VAS), decimals = 2) %>%
  gt::gtsave("Tables/CorrMatrix.html")

```

## Modeling naive OT scores 

This next block is modeling SLP estimation as predictor of naive listener OT.

```{r}

SLP_ESTmodel <- lm(naive_OT ~ slp_EST, data= IntSpeakerRatings)
summary(SLP_ESTmodel)
performance::check_model(SLP_ESTmodel)
sjPlot::tab_model(SLP_ESTmodel, file = "Tables/Estimation_model.html")


```


This next block is examining SLP VAS as a predictor of naive listener OT.

```{r}

SLP_VASmodel <- lm(naive_OT ~ slp_VAS, data = IntSpeakerRatings)
summary(SLP_VASmodel)
performance::check_model(SLP_VASmodel)
sjPlot::tab_model(SLP_VASmodel, file = "Tables/VAS_model.html")

```


Naive OT Model comparisons

```{r}
performance::compare_performance(SLP_ESTmodel, SLP_VASmodel, rank = T)

performance::test_performance(SLP_ESTmodel, SLP_VASmodel)
```


## Additional Analysis: Modeling naive VAS scores

This next block is examining SLP EST as a predictor of naive listener VAS.

```{r}
SLP_ESTmodel_VAS <- lm(naive_VAS ~ slp_EST, data = IntSpeakerRatings)
summary(SLP_ESTmodel_VAS)
performance::check_model(SLP_ESTmodel_VAS)
```

This block examines SLP VAS as a predictor of naive listener VAS.

```{r}
SLP_VASmodel_VAS <- lm(naive_VAS ~ slp_VAS, data = IntSpeakerRatings)
summary(SLP_VASmodel_VAS)
performance::check_model(SLP_VASmodel_VAS)
```

Naive VAS model comparison

```{r}
performance::compare_performance(SLP_ESTmodel_VAS, SLP_VASmodel_VAS, rank = T)

performance::test_performance(SLP_ESTmodel_VAS, SLP_VASmodel_VAS)
```

## RQ1 Plot

```{r}

IntSpeakerRatings_Long <- IntSpeakerRatings %>%
  tidyr::pivot_longer(cols = slp_EST:slp_VAS, names_to = "Method",values_to = "rating") %>%
  dplyr::mutate(Method = recode(Method, slp_EST = "Estimation", slp_VAS = "VAS"))

IntSpeakerRatings_Long %>%
  ggplot() +
  aes(x = rating, 
      y = naive_OT,
      color = Method,
      shape = Method,
      ymin = 0,
      ymax = 100,
      xmin = 0,
      xmax = 100) +
  geom_point() +
  geom_smooth(method = "lm",
              se = F) +
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  ylab("Naïve Listener Intelligibilty (Transcription)") +
  labs(color = "SLP Rating Method", shape = "SLP Rating Method") +
  scale_color_manual(values = my_pal) +
  scale_shape_manual(values = c(1, 16)) +
  coord_equal() +
  theme_classic() +
  theme(legend.position = "bottom",
        axis.title.x=element_blank())

ggsave("Plots/RQ1_ScatterPlot.png", plot = last_plot(), height = 5, width = 5, units = "in", scale = .8)

```


# Research Question #2

## Correlation Analysis
Q2: Is there a strong relationship between SLP intelligibility percent estimates with SLP VAS intelligibility ratings?

```{r}

rmcorr::rmcorr(slpID, slp_VAS, slp_EST, slp_Correlation)

```

## Scatterplot

```{r}

slp_Correlation %>%
  ggplot() +
  aes(x = slp_VAS,
      y = slp_EST) +
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  geom_line(method = "lm", stat ="smooth", color = my_pal[2], aes(group = slpID), alpha = .4) +
  geom_smooth(method = "lm", se = F, color = my_pal[2]) +
  xlab("SLP VAS Rating") +
  ylab("SLP Percent Estimates") +
  coord_cartesian(xlim = c(0, 100), ylim = c(0, 100)) +
  theme_classic() +
  theme(aspect.ratio = 1) 

ggsave("Plots/RQ2_ScatterPlot.png", plot = last_plot(), height = 5, width = 5, units = "in", scale = .8)

```



# Research Question #3

## Repeated Measures Correlation

Q3: Is there a strong relationship between naive listener OT scores with their VAS intelligibility estimation?

```{r}

rmcorr::rmcorr(ListenerID, naive_OT, naive_VAS, naive_Correlation)

```

## Scatterplot

```{r}

naive_Correlation %>%
  ggplot() + 
  aes(x = naive_VAS,
      y = naive_OT) +
  geom_point(color = my_pal[4], alpha = .7, shape = 1) +
  geom_point(data = naive_Correlation %>%
               dplyr::group_by(ListenerID) %>%
               dplyr::summarize(naive_VAS = mean(naive_VAS),
                                naive_OT = mean(naive_OT)), 
             color = my_pal[4], size = 2) +
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  geom_line(data = naive_Correlation %>%
               dplyr::group_by(ListenerID) %>%
               dplyr::summarize(naive_VAS = mean(naive_VAS),
                                naive_OT = mean(naive_OT)),
            method = "lm", stat = "smooth", se = F, color = my_pal[4]) +
  xlab("VAS Ratings") +
  ylab("Orthographic Transcription") +
  coord_cartesian(xlim = c(0,100), ylim = c(0, 100)) +
  theme_classic() +
  theme(aspect.ratio = 1)

ggsave("Plots/RQ3_ScatterPlot.png", plot = last_plot(), height = 5, width = 5, units = "in", scale = .8)

```


# Research Question #4
Q4: How reliable are these intelligibility measures (VAS ratings, approximations, and OT scores), as determined by intrarater and interrater agreement?

## Intrarater Reliability

### SLP VAS Ratings

```{r}

cor.test(slp_Correlation$slp_VAS, slp_Correlation$slp_VAS.Rel, method = "pearson", use = "complete.obs")

```

### SLP EST Ratings

```{r}

cor.test(slp_Correlation$slp_EST, slp_Correlation$slp_EST.Rel, method = "pearson", use = "complete.obs")

```

## Interrater Reliability 

### SLPs VAS rating

```{r}

slpVAS_Inter <- slp_Correlation %>%
  dplyr::select(!c(slp_VAS.Rel, slp_EST, slp_EST.Rel))

slpVAS_Inter_wide <- tidyr::pivot_wider(slpVAS_Inter, names_from = slpID, values_from = slp_VAS)

slpVAS_Inter_wide <- slpVAS_Inter_wide %>%
  dplyr::select(!Speaker)

k <- 1
while(k <= ncol(slpVAS_Inter_wide)){
  slpVAS_Inter_wide[is.na(slpVAS_Inter_wide[,k]), k] <- colMeans(slpVAS_Inter_wide[,k], na.rm = TRUE)
  k <- k + 1
}

irr::icc(slpVAS_Inter_wide, model = "twoway",
  type="agreement",
  unit="average", r0=0, conf.level=0.95)

irr::icc(slpVAS_Inter_wide, model = "twoway",
  type="agreement",
  unit="single", r0=0, conf.level=0.95)
```

### SLPs Estimations

```{r}

slpEST_Inter <- slp_Correlation %>%
  dplyr::select(!c(slp_EST.Rel, slp_VAS, slp_VAS.Rel))

slpEST_Inter_wide <- tidyr::pivot_wider(slpEST_Inter, names_from = slpID, values_from = slp_EST)

slpEST_Inter_wide <- slpEST_Inter_wide %>%
  dplyr::select(!Speaker)

irr::icc(slpEST_Inter_wide, model = "twoway",
  type="agreement",
  unit="average", r0=0, conf.level=0.95)

irr::icc(slpEST_Inter_wide, model = "twoway",
  type="agreement",
  unit="single", r0=0, conf.level=0.95)

```

